<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>Lucas L. Azevedo | The fast inverse square root, one of my favourite Algorithms!</title>
<meta name="description" content="A simple website to keep projects and publications up-to-date.
">

<!-- Open Graph -->


<!-- Bootstrap & MDB -->
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/css/mdb.min.css" integrity="sha512-RO38pBRxYH3SoOprtPTD86JFOclM51/XTIdEPh5j8sj4tp8jmQIx26twG52UaLi//hQldfrh7e51WzP9wuP32Q==" crossorigin="anonymous" />

<!-- Fonts & Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css"  integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.0/css/academicons.min.css" integrity="sha512-W4yqoT1+8NLkinBLBZko+dFB2ZbHsYLDdr50VElllRcNt2Q4/GSs6u71UHKxB7S6JEMCp5Ve4xjh3eGQl/HRvg==" crossorigin="anonymous">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

<!-- Code Syntax Highlighting -->
<link rel="stylesheet" href="https://gitcdn.xyz/repo/jwarby/jekyll-pygments-themes/master/github.css" />

<!-- Styles -->

<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üëæ</text></svg>">

<link rel="stylesheet" href="/assets/css/main.css">

<link rel="canonical" href="/blog/2021/fsqrt/">

<!-- JQuery -->
<!-- jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>


<!-- Theming-->

  <script src="/assets/js/theme.js"></script>
  <!-- Load DarkMode JS -->
<script src="/assets/js/dark_mode.js"></script>






    
<!-- MathJax -->
<script type="text/javascript">
  window.MathJax = {
    tex: {
      tags: 'ams'
    }
  };
</script>
<script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js"></script>
<script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>


  </head>

  <body class="fixed-top-nav ">

    <!-- Header -->

    <header>

    <!-- Nav Bar -->
    <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
    <div class="container">
      
      <a class="navbar-brand title font-weight-lighter" href="/">
       <span class="font-weight-bold">Lucas</span> L.  Azevedo
      </a>
      
      <!-- Navbar Toggle -->
      <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar top-bar"></span>
        <span class="icon-bar middle-bar"></span>
        <span class="icon-bar bottom-bar"></span>
      </button>
      <div class="collapse navbar-collapse text-right" id="navbarNav">
        <ul class="navbar-nav ml-auto flex-nowrap">
          <!-- About -->
          <li class="nav-item ">
            <a class="nav-link" href="/">
              about
              
            </a>
          </li>

          
          <li class="nav-item active">
            <a class="nav-link" href="/blog/">
              blog
              
            </a>
          </li>
          

	  <!--
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/projects/">
                projects
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/publications/">
                publications
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/teaching/">
                teaching
                
              </a>
          </li>
          
          
	  -->

          
            <div class = "toggle-container">
              <a id = "light-toggle">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
              </a>
            </div>
          
        </ul>
      </div>
    </div>
  </nav>

</header>


    <!-- Content -->

    <div class="container mt-5">
      

<div class="post">

  <header class="post-header">
    <h1 class="post-title">The fast inverse square root, one of my favourite Algorithms!</h1>
    <p class="post-meta">November 23, 2021</p>
  </header>

  <article class="post-content">
    <p>I like a lot of algorithms for their ingeniousness and simplicity into solving problems,but one in particular stands out when those two qualities are taken into account: the fast inverse square root, created by <a href="https://en.wikipedia.org/wiki/John_Carmack">John Carmack</a>, that made it possible for personal computers from the 90‚Äôs to render enough surfaces as to make 3D video-gaming viable. The inverse of a square root is used to normalize the magnitude ofthe vectors that represent each surface to be rendered, thus, this operation is used extensively by the game engine. Consequently, any reduction on its computational costs would heavily impact on the overall performance of the code.</p>

<p>Carmack wrote his implementation of the fast inverse square root (see Algorithm 1, that includes his <s>original</s> censored comments) in the C language despite the fact that all of its needed operations were already available through the &lt;math.io&gt; library. He made that in order to substitute costly operations for faster ones.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">float</span> <span class="n">Q_rsqrt</span><span class="p">(</span> <span class="nb">float</span> <span class="n">number</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="nb">long</span> <span class="n">i</span><span class="p">;</span>
	<span class="nb">float</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
	<span class="n">const</span> <span class="nb">float</span> <span class="n">threehalfs</span> <span class="o">=</span> <span class="mf">1.5</span><span class="n">F</span><span class="p">;</span>

	<span class="n">x2</span> <span class="o">=</span> <span class="n">number</span> <span class="o">*</span> <span class="mf">0.5</span><span class="n">F</span><span class="p">;</span>
	<span class="n">y</span>  <span class="o">=</span> <span class="n">number</span><span class="p">;</span>
	<span class="n">i</span>  <span class="o">=</span> <span class="o">*</span> <span class="p">(</span> <span class="nb">long</span> <span class="o">*</span> <span class="p">)</span> <span class="o">&amp;</span><span class="n">y</span><span class="p">;</span>                       <span class="o">//</span> <span class="n">evil</span> <span class="n">floating</span> <span class="n">point</span> <span class="n">bit</span> <span class="n">level</span> <span class="n">hacking</span>
	<span class="n">i</span>  <span class="o">=</span> <span class="mh">0x5f3759df</span> <span class="o">-</span> <span class="p">(</span> <span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span> <span class="p">);</span>               <span class="o">//</span> <span class="n">what</span> <span class="n">the</span> <span class="n">f</span><span class="o">***</span><span class="err">?</span> 
	<span class="n">y</span>  <span class="o">=</span> <span class="o">*</span> <span class="p">(</span> <span class="nb">float</span> <span class="o">*</span> <span class="p">)</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">;</span>
	<span class="n">y</span>  <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="p">(</span> <span class="n">threehalfs</span> <span class="o">-</span> <span class="p">(</span> <span class="n">x2</span> <span class="o">*</span> <span class="n">y</span> <span class="o">*</span> <span class="n">y</span> <span class="p">)</span> <span class="p">);</span>   <span class="o">//</span> <span class="mi">1</span><span class="n">st</span> <span class="n">iteration</span>
<span class="o">//</span>	<span class="n">y</span>  <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="p">(</span> <span class="n">threehalfs</span> <span class="o">-</span> <span class="p">(</span> <span class="n">x2</span> <span class="o">*</span> <span class="n">y</span> <span class="o">*</span> <span class="n">y</span> <span class="p">)</span> <span class="p">);</span>   <span class="o">//</span> <span class="mi">2</span><span class="n">nd</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">this</span> <span class="n">can</span> <span class="n">be</span> <span class="n">removed</span>

	<span class="k">return</span> <span class="n">y</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<div align="center">
<figcaption>
Algorithm 1
</figcaption>
</div>
<p><br /></p>

<p>The most interesting aspect of this algorithm is that Carmack found a very good approximation (for numbers in the required range, i.e., 0 to 1) to a function that allows the mantissa and the exponential parts of a number to be obtained by a simple operation over the bit values that represent that number. The in-depth explanation of this won‚Äôt be covered here but relies on the fact that log<sub>2</sub>(1+x) &amp;cong log<sub>2</sub>(x). In fact the identity holds for <strong><em>x</em></strong> &amp;isin {0,1} and can have it‚Äôs average error reduced by adding a constant.</p>

<p>In order to perform those operations in the most efficient way, some bit manipulation is required (see line 10 of <strong><em>Algorithm 1</em></strong>) which, in turn, requires the number to be stored by an integer registry. Nevertheless, if a simple cast to integer were to be applied to the float variable <strong><em>y</em></strong> the information regarding the floating part of the number represented by the float registry would be lost. That is why the conversion has to be made in such a way that the compiler interprets the information held by the float registry as a long, which explains the long pointer used over the float address (see line 9 of <strong><em>Algorithm 1</em></strong>).</p>

<p>Once the input number is represented as an integer in <strong><em>i</em></strong> is when the operations over the value start. From the inverse square root, the log function is applied and after some manipulation, the same result can be obtained by applying a <em>division by two</em> and a <em>logarithm</em>, two much simpler and faster operations.</p>

<div align="center">
<img src="https://render.githubusercontent.com/render/math?math=\frac{1}{\sqrt{x}} \rightarrow \log_2{\left(\frac{1}{\sqrt{x}}\right)} \rightarrow \log_2{\left(y^{-\frac{1}{2}}\right)} \rightarrow -\frac{1}{2}\log_2{\left(y\right)}" />
</div>
<p><br /></p>

<p>The division by 2 can be optimally applied with the infamous bit shift to the right (see line 10 of <strong><em>Algorithm 1</em></strong>). For example: when 110 which represents 6 in binary, is shifted to the right, it becomes 11 which represents 3. That is how simple and fast a division (or multiplication, if it were to the left) by 2 happens on a registry level operation, that would most likely be done in one processing cycle, i.e. <strong><em>O(1)</em></strong></p>

<p>That explains the <strong><em>- (i¬†¬ª 1)</em></strong> bit, but what about <strong><em>0x5f3759df</em></strong> This hexadecimal number is a constant that results from the combination of the two constants mentioned before: the one that gives an approximation of the value of <strong><em>y</em></strong> from its bits representation; and the one that reduces the error of the logarithmic operations applied before.</p>

<p>As said, the result is an approximation, so after doing the inverse casting of the integer <strong><em>i</em></strong> back to our float <strong><em>y</em></strong> (see line 11 of <strong>Algorithm 1</strong>}), the last instruction is a Newton Iteration which, as the name suggests, is an iterative method for approximation. The idea behind this is to get a very good approximation from a decent one. Since one iteration yields very low errors for this case, the second one was commented out.</p>

<p>By switching <em>square root</em> and <em>division</em> for four multiplications, two subtractions and a bit shift operation, while obtaining a very good approximation, Carmack‚Äôs fast square root achieved way more than just a ‚Äúbit‚Äù of processing time.</p>

  </article>

  

</div>

    </div>

    <!-- Footer -->

    
<footer class="fixed-bottom">
  <div class="container mt-0">
    &copy; Copyright 2021 Lucas L. Azevedo.
    Powered by <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank">GitHub Pages</a>.

    
    
  </div>
</footer>



  </body>

  <!-- Bootsrap & MDB scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.4.4/umd/popper.min.js" integrity="sha512-eUQ9hGdLjBjY3F41CScH3UX+4JDSI9zXeroz7hJ+RteoCaY+GP/LDoM8AO+Pt+DRFw3nXqsjh9Zsts8hnYv8/A==" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha512-M5KW3ztuIICmVIhjSqXe01oV2bpe248gOxqmlcYrEzAvws7Pw3z6BK0iGbrwvdrUQUhi3eXgtxp5I8PDo9YfjQ==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/js/mdb.min.js" integrity="sha512-Mug9KHKmroQFMLm93zGrjhibM2z2Obg9l6qFG2qKjXEXkMp/VDkI4uju9m4QKPjWSwQ6O2qzZEnJDEeCw0Blcw==" crossorigin="anonymous"></script>

  
<!-- Mansory & imagesLoaded -->
<script defer src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
<script defer src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
<script defer src="/assets/js/mansory.js" type="text/javascript"></script>


  


<!-- Load Common JS -->
<script src="/assets/js/common.js"></script>


</html>
